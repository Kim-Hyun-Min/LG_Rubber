# ê³ ë¬´ë„ì¥ ì´ë¯¸ì§€ í•©ì„± ë„êµ¬ (compose_advanced.py)

ë¶„í•  ì´¬ì˜ëœ ê³ ë¬´ë„ì¥ ì´ë¯¸ì§€(ìƒë‹¨/í•˜ë‹¨)ë¥¼ ì›ë³¸ ë†’ì´ë¡œ ë³µì›í•˜ëŠ” ê³ ê¸‰ ì´ë¯¸ì§€ í•©ì„± í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

## ì£¼ìš” íŠ¹ì§•

### ğŸ¯ ì¡°ëª… ì°¨ì´ ê°•ê±´ì„±
- **4ê°€ì§€ ì¡°ëª… ë¶ˆë³€ ì§€í‘œ** ì‚¬ìš©ìœ¼ë¡œ ë°ê¸° ì°¨ì´ê°€ ìˆì–´ë„ ì •í™•í•œ ë§¤ì¹­
- Affine MSE, Z-score MSE, Gradient MSE, Stripe Score í˜¼í•© í‰ê°€
- ë°˜ì‚¬ê´‘, ê·¸ë¦¼ì ë“± ì´ìƒì¹˜ì— ê°•ê±´í•œ ì•Œê³ ë¦¬ì¦˜

### ğŸ” 2ë‹¨ê³„ íƒìƒ‰ ì „ëµ
- **Stage 1 (Coarse)**: 5~40% ë²”ìœ„ ì „ì—­ íƒìƒ‰ìœ¼ë¡œ ìµœì  í›„ë³´ ë°œê²¬
- **Stage 2 (Refine)**: í›„ë³´ ì£¼ë³€ Â±2% ì •ë°€ íƒìƒ‰ìœ¼ë¡œ í”½ì…€ ë‹¨ìœ„ ìµœì í™”
- ì´ˆê¸° ì¶”ì •ê°’ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ê²¬ê³ í•œ íƒìƒ‰

### ğŸ§  í•˜ì´ë¸Œë¦¬ë“œ ì˜ì‚¬ê²°ì •
- **ê¸°í•˜í•™ì  ì¶”ì •** (ì›ë³¸ ë†’ì´ ê¸°ë°˜) + **í”„ë¡œíŒŒì¼ ë§¤ì¹­** ê²°í•©
- ë‹¤ì¤‘ ì§€í‘œ ì‹ ë¢°ë„ í‰ê°€ë¡œ ë³´ìˆ˜ì  ê²°ì •
- ì •ë³´ ì†ì‹¤ ê°ì§€ ë° ê²½ê³  ì‹œìŠ¤í…œ

---

## ì„¤ì¹˜

### í•„ìˆ˜ íŒ¨í‚¤ì§€
```bash
pip install opencv-python numpy
```

### Python ë²„ì „
- Python 3.7 ì´ìƒ

---

## ì‚¬ìš© ë°©ë²•

### ê¸°ë³¸ ì‚¬ìš©ë²•

```bash
python compose_improved.py \
  --top-dir ./s_data/img1 \
  --bot-dir ./s_data/img2 \
  --out ./output
```

### ì›ë³¸ ë†’ì´ ìë™ ì¶”ì •

```bash
python compose_improved.py \
  --top-dir ./s_data/img1 \
  --bot-dir ./s_data/img2 \
  --original-dir ./original_stamps \
  --out ./output
```

### ê³µí†µ ì›ë³¸ ë†’ì´ ì§€ì •

```bash
python compose_improved.py \
  --top-dir ./s_data/img1 \
  --bot-dir ./s_data/img2 \
  --original-height 2000 \
  --out ./output
```

### ê°œë³„ ë†’ì´ íŒŒì¼ ì‚¬ìš©

```bash
# heights.txt í˜•ì‹:
# stamp001.png,2000
# stamp002.png,1850
# stamp003.png,2100

python compose_improved.py \
  --top-dir ./s_data/img1 \
  --bot-dir ./s_data/img2 \
  --height-file heights.txt \
  --out ./output
```

---

## ëª…ë ¹í–‰ ì˜µì…˜

| ì˜µì…˜ | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `--top-dir` | ìƒë‹¨ ì´ë¯¸ì§€ í´ë” | `./s_data/img1` |
| `--bot-dir` | í•˜ë‹¨ ì´ë¯¸ì§€ í´ë” | `./s_data/img2` |
| `--out` | ì¶œë ¥ í´ë” | `compose_improved` |
| `--original-dir` | ì›ë³¸ ì´ë¯¸ì§€ í´ë” (ë†’ì´ ì¶”ì •ìš©) | None |
| `--original-height` | ê³µí†µ ì›ë³¸ ë†’ì´ (í”½ì…€) | None |
| `--height-file` | ê°œë³„ ë†’ì´ ì •ë³´ íŒŒì¼ | None |
| `--bg-threshold` | ë°°ê²½ íŒë‹¨ ì„ê³„ê°’ (0-255) | 245 |

---

## í´ë” êµ¬ì¡°

```
project/
â”œâ”€â”€ compose_improved.py
â”œâ”€â”€ s_data/
â”‚   â”œâ”€â”€ img1/              # ìƒë‹¨ ì´ë¯¸ì§€
â”‚   â”‚   â”œâ”€â”€ stamp001.png
â”‚   â”‚   â”œâ”€â”€ stamp002.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ img2/              # í•˜ë‹¨ ì´ë¯¸ì§€
â”‚       â”œâ”€â”€ stamp001.png
â”‚       â”œâ”€â”€ stamp002.png
â”‚       â””â”€â”€ ...
â”œâ”€â”€ original_stamps/       # (ì„ íƒ) ì›ë³¸ ì´ë¯¸ì§€
â”‚   â”œâ”€â”€ stamp001.png
â”‚   â””â”€â”€ ...
â””â”€â”€ output/                # ê²°ê³¼ ì¶œë ¥
    â”œâ”€â”€ stamp001_restored.png
    â””â”€â”€ ...
```

**ì¤‘ìš”**: ìƒë‹¨/í•˜ë‹¨ ì´ë¯¸ì§€ëŠ” **íŒŒì¼ëª…ì´ ë™ì¼**í•´ì•¼ í•©ë‹ˆë‹¤ (í™•ì¥ìëŠ” ë‹¬ë¼ë„ ë¬´ê´€).

---

ë¶„í•  í›„ ì¤‘ì•™ê°’
- **íš¨ê³¼**: ë°˜ì‚¬ê´‘, ê·¸ë¦¼ì ë“± ì´ìƒì¹˜ ì–µì œ

### ì‹ ë¢°ë„ í‰ê°€ ê¸°ì¤€

```python
âœ“ High confidence (0.95):
  - Affine MSE < 300
  - Z-score Correlation > 0.6
  - Stripe Variance < 50

âš  Medium confidence (0.75):
  - ìœ„ ì¡°ê±´ ì¤‘ 2ê°œ ë§Œì¡±

âš  Low confidence (0.50):
  - ìœ„ ì¡°ê±´ ì¤‘ 1ê°œ ë§Œì¡±

âœ— Very low (0.20):
  - ëª¨ë“  ì¡°ê±´ ë¶ˆë§Œì¡±
```

---

## ì¶œë ¥ ì˜ˆì‹œ

```
Processing: stamp001

  Content heights - Top: 1050, Bot: 1120
  âœ“ ì›ë³¸ ë†’ì´ ì¶”ì •: 2000px (from stamp001.png)

  [Stage 1] Coarse search: 50~800px (step=25)
  [Stage 1] Best: 325px (score=45.23)

  [Stage 2] Refine search: 285~365px (Â±40px)
  [Stage 2] Best: 318px (combined=42.15)
            Affine MSE=245.3, Z-MSE=0.38
            Grad MSE=182.7, Corr(Z)=0.823
            Stripe var=28.4

  âœ“ High confidence match (all criteria passed)
  Geometric estimate: 320px (confidence=0.7)
  Final overlap: 319px (hybrid(Î±=0.58,geom=320,match=318))

  Result: 1500Ã—1999
  Accuracy: -1px (-0.1%)
  âœ“ Saved: stamp001_restored.png

==================================================
SUCCESS: 100/100
Avg error: 2.3px
Output: ./output
```

---

## ì•Œê³ ë¦¬ì¦˜ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ì…ë ¥ ì´ë¯¸ì§€ ë¡œë“œ (Top / Bottom)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ê³ ë¬´ ì˜ì—­ ê²½ê³„ ë¶„ì„                   â”‚
â”‚     - ë°°ê²½(bg_threshold) ê¸°ë°˜ ë§ˆìŠ¤í‚¹     â”‚
â”‚     - ì—°ì† êµ¬ê°„ ì¶”ì¶œ â†’ ë©”ì¸ ì˜ì—­ ì‹ë³„    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ì›ë³¸ ë†’ì´ ì¶”ì • (ì„ íƒ)                â”‚
â”‚     - original-dir ì´ë¯¸ì§€ ë¶„ì„           â”‚
â”‚     - ê¸°í•˜í•™ì  ì´ˆê¸°ê°’ ê³„ì‚°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (ë„ˆë¹„ ì •ë ¬)           â”‚
â”‚     - ë¹„ë¡€ ë¦¬ì‚¬ì´ì¦ˆ (LANCZOS4)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. 2ë‹¨ê³„ ê²¹ì¹¨ì  íƒìƒ‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Stage 1: Coarse (5~40%)         â”‚    â”‚
â”‚  â”‚  - 4ì§€í‘œ í˜¼í•© í‰ê°€               â”‚    â”‚
â”‚  â”‚  - ìµœì  í›„ë³´ ì„ ì •               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Stage 2: Refine (Â±2%)           â”‚    â”‚
â”‚  â”‚  - 1px ë‹¨ìœ„ ì •ë°€ íƒìƒ‰            â”‚    â”‚
â”‚  â”‚  - ë‹¤ì¤‘ ì§€í‘œ ì‹ ë¢°ë„ í‰ê°€         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. í•˜ì´ë¸Œë¦¬ë“œ ì˜ì‚¬ê²°ì •                   â”‚
â”‚     - ê¸°í•˜ ì¶”ì • vs í”„ë¡œíŒŒì¼ ë§¤ì¹­ ë¹„êµ    â”‚
â”‚     - ì‹ ë¢°ë„ ê¸°ë°˜ ê°€ì¤‘ í‰ê·               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. í”„ë¡œíŒŒì¼ ì¸ì‹ ë¸”ë Œë”©                  â”‚
â”‚     - í–‰ë³„ ì ì‘ì  ì•ŒíŒŒ ë¸”ë Œë”©            â”‚
â”‚     - S-curve ë¶€ë“œëŸ¬ìš´ ì „í™˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. ìµœì¢… í•©ì„± ë° ì €ì¥                     â”‚
â”‚     - ìº”ë²„ìŠ¤ ìƒì„± (ë°°ê²½: #F8F5F0)        â”‚
â”‚     - PNG ì¶œë ¥                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë¬¸ì œ í•´ê²°

### Q1. "No matching pairs found" ì˜¤ë¥˜
**ì›ì¸**: ìƒë‹¨/í•˜ë‹¨ í´ë”ì˜ íŒŒì¼ëª…ì´ ë‹¤ë¦„  
**í•´ê²°**: íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)ì„ ë™ì¼í•˜ê²Œ ë§ì¶”ì„¸ìš”

```bash
# ì˜ˆì‹œ
img1/stamp001.png
img2/stamp001.jpg  # í™•ì¥ìëŠ” ë‹¬ë¼ë„ OK
```

### Q2. "Analysis failed" ê²½ê³ 
**ì›ì¸**: ë°°ê²½ ì„ê³„ê°’ì´ ë¶€ì ì ˆ  
**í•´ê²°**: `--bg-threshold` ì¡°ì • (ê¸°ë³¸ê°’: 245)

```bash
# ì–´ë‘ìš´ ë°°ê²½ì¸ ê²½ìš°
python compose_improved.py --bg-threshold 200

# ë°ì€ ë°°ê²½ì¸ ê²½ìš°
python compose_improved.py --bg-threshold 250
```

### Q3. ë³µì› ë†’ì´ ì˜¤ì°¨ê°€ í¼
**ì›ì¸**: ì›ë³¸ ë†’ì´ ì •ë³´ ë¶€ì¬  
**í•´ê²°**: `--original-dir` ë˜ëŠ” `--original-height` ì œê³µ

```bash
# ë°©ë²• 1: ì›ë³¸ í´ë” ì œê³µ (ìë™ ì¶”ì •)
python compose_improved.py --original-dir ./originals

# ë°©ë²• 2: ë†’ì´ ì§ì ‘ ì§€ì •
python compose_improved.py --original-height 2000
```

### Q4. ì¡°ëª… ì°¨ì´ê°€ ì‹¬í•´ë„ ì‹¤íŒ¨
**ì›ì¸**: ë§¤ìš° ê·¹ë‹¨ì ì¸ ì¡°ëª… ë³€í™”  
**í•´ê²°**: 
1. í˜„ì¬ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œë„ ëŒ€ë¶€ë¶„ í•´ê²°ë˜ì§€ë§Œ
2. í•„ìš”ì‹œ `aff_mse`, `corr_z`, `stripe_var` ì„ê³„ê°’ ì™„í™”

```python
# compose_improved.py ë‚´ë¶€ ìˆ˜ì •
# Line ~245 ë¶€ê·¼
cond1 = aff_mse < 500      # 300 â†’ 500ìœ¼ë¡œ ì™„í™”
cond2 = corr_z > 0.4       # 0.6 â†’ 0.4ë¡œ ì™„í™”
cond3 = stripe_var < 100   # 50 â†’ 100ìœ¼ë¡œ ì™„í™”
```

---

## ì„±ëŠ¥ ìµœì í™” íŒ

### ëŒ€ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬
```python
# ë©€í‹°í”„ë¡œì„¸ì‹± ì¶”ê°€ (í–¥í›„ ë²„ì „)
from multiprocessing import Pool

with Pool(processes=4) as pool:
    pool.map(stitch_with_profile_analysis, image_pairs)
```

### ë©”ëª¨ë¦¬ ì ˆì•½
```bash
# í° ì´ë¯¸ì§€ëŠ” ë¦¬ì‚¬ì´ì¦ˆ í›„ ì²˜ë¦¬
# ë‚´ë¶€ ì½”ë“œì—ì„œ ìë™ìœ¼ë¡œ ë„ˆë¹„ ì •ë ¬í•˜ë¯€ë¡œ ë³„ë„ ì‘ì—… ë¶ˆí•„ìš”
```

---

## ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­

### ì§€ì› ì´ë¯¸ì§€ í˜•ì‹
- PNG, JPG/JPEG, BMP, TIF/TIFF, WebP

### ìƒ‰ê³µê°„ ì²˜ë¦¬
- ì…ë ¥: RGB
- ë¶„ì„: Grayscale ë³€í™˜ í›„ ì²˜ë¦¬
- ì¶œë ¥: RGB (ë°°ê²½ #F8F5F0)

### ë³´ê°„ ë°©ë²•
- ë¦¬ì‚¬ì´ì¦ˆ: LANCZOS4 (ê³ í’ˆì§ˆ)
- ë¸”ë Œë”©: S-curve ì ì‘ì  ì•ŒíŒŒ

---

## ë¼ì´ì„ ìŠ¤

MIT License

---

## ë²„ì „ íˆìŠ¤í† ë¦¬

### v2.0 (2025-10-02)
- âœ¨ 2ë‹¨ê³„ íƒìƒ‰ ì „ëµ (Coarseâ†’Refine)
- âœ¨ 4ê°€ì§€ ì¡°ëª… ë¶ˆë³€ ì§€í‘œ (Affine, Z-score, Gradient, Stripe)
- âœ¨ ë‹¤ì¤‘ ì§€í‘œ ì‹ ë¢°ë„ í‰ê°€
- âœ¨ í•˜ì´ë¸Œë¦¬ë“œ ì˜ì‚¬ê²°ì • (ê¸°í•˜+ë§¤ì¹­)
- ğŸ› ì¡°ëª… ì°¨ì´ í™˜ê²½ì—ì„œ ì •í™•ë„ ëŒ€í­ ê°œì„ 

### v1.0 (Initial)
- ê¸°ë³¸ í”„ë¡œíŒŒì¼ ë§¤ì¹­
- ë‹¨ì¼ MSE í‰ê°€
- ì›ë³¸ ë†’ì´ ê¸°ë°˜ ì´ˆê¸° ì¶”ì •

---

## ë¬¸ì˜ ë° ê¸°ì—¬

ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ê°œì„  ì œì•ˆì´ ìˆìœ¼ì‹œë©´ ì´ìŠˆë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.

---

## ì°¸ê³  ìë£Œ

### ì•Œê³ ë¦¬ì¦˜ ë…¼ë¬¸
- Image Stitching using Affine Transformations
- Robust Image Matching under Illumination Variations
- Multi-Scale Feature Detection for Image Registration

### ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬
- [OpenCV](https://opencv.org/) - ì´ë¯¸ì§€ ì²˜ë¦¬
- [NumPy](https://numpy.org/) - ìˆ˜ì¹˜ ì—°ì‚°